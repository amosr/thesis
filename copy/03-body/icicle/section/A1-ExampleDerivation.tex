%!TEX root = ../Main.tex

\onecolumn
% ---------------------------------------------------------
\appendix
\section{Derivation}

\subsection{Function last}

\newcommand\kEltDate { @k@~:~@Element Date@ }


$$
\ruleIN
{
  \ruleIN
  {
    \Typecheck
      {\Gamma,~\kEltDate}
      {0}
      {@Date@}
    \quad
    \ruleIN
    {
    }
    {
    \Typecheck
      {\Gamma,~\kEltDate,~@l@~:~@Element Date@}
      {k}
      {@Element Date@}
    }{TcVar}
  }
  {
    \Typecheck
    {
      \Gamma, \kEltDate
    }
    {
      @fold l = 0 then k@
    }
    {@Aggregate Date@}
  }{TcFold}
}
{
  \TypecheckS
    {\Gamma}
    {
      \arrayZ{
      @function last (k : Element Date)@ \\
      @ = fold l = 0 then k@
      }
    }
    {\Gamma,~@last@~:~@Element Date@~\to~@Aggregate Date@}
}
{CheckFun}
$$

\subsection{Function mean}

\newcommand\vEltReal { @v@~:~@Element Real@ }

$$
\ruleIN
{
  \ruleIN
  {
    \TypecheckP
      {(/)}{@Real@~\to~@Real@~\to~@Real@}
    \quad
    \ruleIN
    {
    }
    {
    \Typecheck
      {\Gamma,~\vEltReal}
      {@fold s = 0 then s + v@}
      {@Aggregate Real@}
    }{TcFold}
    \quad
    \ruleIN
    {
    }
    {
    \Typecheck
      {\Gamma,~\vEltReal}
      {@fold c = 0 then c + 1@}
      {@Aggregate Real@}
    }{TcFold}
  }
  {
    \Typecheck
    {
      \Gamma, \vEltReal
    }
    {
      @(/) (fold s = 0 then s + v) (fold c = 0 then c + 1)@
    }
    {@Aggregate Real@}
  }{TcPrimApp}
}
{
  \TypecheckS
    {\Gamma}
    {
      \arrayZ{
      @function mean (v : Element Real)@ \\
      @ = (fold s = 0 then s + v)@
      @ / (fold c = 0 then c + 1)@
      }
    }
    {\Gamma,~@mean@~:~@Element Real@~\to~@Aggregate Real@}
}
{CheckFun}
$$


\subsection{Query group}

$$
\ruleIN
{
  \ruleIN
  {
  }
  {
    \TypecheckS
    {
      \left\{
      \begin{array}{l}
        @key@~:~@Element Date@,~@value@~:~@Element Real@  \\
        @last@~:~@Element Date@~\to~@Aggregate Date@ \\
        @mean@~:~@Element Real@~\to~@Aggregate Real@ \\
      \end{array}
      \right\}
    }
    {
        \begin{array}{l}
          @query avg = let k    = last key@ \\
          @            let avgs = group key of mean value@ \\
          @            in  lookup k avgs@
        \end{array}
    }
    {\Gamma_j}
  }{CheckQuery}
}
{
  \TypecheckS
    {}
    {
      \begin{array}{l}
        @table kvs \{key : Date; value : Real\}@ \\
        @query avg = let k    = last key@ \\
        @            let avgs = group key of mean value@ \\
        @            in  lookup k avgs@
      \end{array}
    }
    {\Gamma_j}
}
{CheckTop}
$$

% table kvs { key : Date; value : Real }
% query avg = let k    = last  key in
%             let avgs = group key of mean value
%             in  lookup k avgs
