\usepackage{listings}
\usepackage{lstlinebgrd}
\usepackage{etoolbox}
\usepackage{letltxmacro}

\colorlet{TemplateStage}{Blue}

\lstdefinelanguage{Haskell}%
  {morekeywords={if,then,else,case,class,data,default,deriving,%
      hiding,in,infix,infixl,infixr,import,instance,let,module,%
      newtype,of,as,qualified,type,where,do,return,forall},%
   keepspaces,%
   sensitive,%
   morecomment=[l]--,%
   morecomment=[n]{\{-}{-\}},%
   morestring=[b]",%
  moredelim=**[is][\color{TemplateStage}]{@}{@},
   % Single char doesn't work as a string because of primes
   % morestring=[b]'%
   % Nice symbols
   literate={+}{{$+$}}1 {/}{{$/$}}1 {*}{{$*$}}1 {=}{{$=$}}1
            {>}{{$>$}}1 {<}{{$<$}}1 {\\}{{$\lambda$}}1
            {\\\\}{{\char`\\\char`\\}}1
            {->}{{$\rightarrow$}}2 {>=}{{$\geq$}}2 {<-}{{$\leftarrow$}}2
            {<=}{{$\leq$}}2 {=>}{{$\Rightarrow$}}2 
            {/=}{{$\ne$}}2
            % Disable space-then-dot as function composition because Conduit uses .| to fuse
            % {\ .}{{$\circ$}}2
            {\ .\ }{{$\circ$}}3
            {>>}{{>>}}2 {>>=}{{>>=}}2
            {|}{{$\mid$}}1
  % Template Haskell splicing / quoting
  % Use untyped TH syntax because it's less noisy.
  % Splice start: turn colour to splice colour
%            {$$(}{{\$\$(}}3
%  % Splice end: this needs to be written as dollar-close in the listing.
%  % Turn colour back to normal
%            {$$)}{{\textcolor{TemplateStage}{)}\color{DoDoPo}}}1
%  % Quote start: presumably outside is a splice, so set colour back to normal
%            {[|}{{  \color{blue} $\llbracket$ }}2
%  % Quote end: presumably exiting back to splice, so change to splice colour
%            {|]}{{ $\rrbracket$  }}2
%  % Explicit colour revert: because I am silly
%            {$$END}{{ \color{black} }}1
  % Quote start: presumably outside is a splice, so set colour back to normal
            {[|}{{[$|$}}2
            {|]}{{$|$]}}2
            {[||}{{[$\|$}}2
  % Quote end: presumably exiting back to splice, so change to splice colour
            {||]}{{$\|$]}}2
  }[keywords,comments,strings]%
\lstset{language=Haskell}

\lstset{%
    rulecolor={\color[gray]{0.7}},
    numbers=none,
    numberstyle=\color{Gray}\tiny\it,
    commentstyle=\color{MidnightBlue}\it,
    stringstyle=\color{Maroon},
    keywordstyle=[1]\color{OliveGreen},
    % keywordstyle=[2]\color{ForestGreen},
    % keywordstyle=[3]\color{Bittersweet},
    % keywordstyle=[4]\color{RoyalPurple},
    captionpos=b,
    aboveskip=1\medskipamount,
    belowskip=1\medskipamount,
    framesep=1.5em,
    xleftmargin=0.5\parindent,
    xrightmargin=0.5\parindent,
    flexiblecolumns=false,
    escapechar={\%},
    texcl=true,
    showstringspaces=false,
    frame=l,
}

\lstset{
  basicstyle=\small\ttfamily,
  flexiblecolumns=false,
  basewidth={0.5em,0.45em},
}

\lstdefinelanguage{icicle}%
  {morekeywords={table,let,fold,filter,group,in,of,then,function,query,%
                Int,Bool,Map,Element,Aggregate,Date,},%
   keepspaces,%
   sensitive,%
   morecomment=[l]--,%
   morecomment=[n]{\{-}{-\}},%
   morestring=[b]",%
   % Single char doesn't work as a string because of primes
   % morestring=[b]'%
   % Nice symbols
   literate={+}{{$+$}}1 {/}{{$/$}}1 {*}{{$*$}}1 {=}{{$=$}}1
            {>}{{$>$}}1 {<}{{$<$}}1 {\\}{{$\lambda$}}1
            {\\\\}{{\char`\\\char`\\}}1
            {->}{{$\rightarrow$}}2 {>=}{{$\geq$}}2 {<-}{{$\leftarrow$}}2
            {<=}{{$\leq$}}2 {=>}{{$\Rightarrow$}}2 
            {/=}{{$\ne$}}2
            {|}{{$\mid$}}1
  }[keywords,comments,strings]%

\lstdefinelanguage{icicle-core}%
  {morekeywords={plan,fold,then,filter,group,%
                before,folds,after,return,%
                Int,Bool,Map,Element,Aggregate,Date,},%
   keepspaces,%
   sensitive,%
   morecomment=[l]--,%
   morecomment=[n]{\{-}{-\}},%
   morestring=[b]",%
   % Single char doesn't work as a string because of primes
   % morestring=[b]'%
   % Nice symbols
   literate={+}{{$+$}}1 {/}{{$/$}}1 {*}{{$*$}}1 {=}{{$=$}}1
            {>}{{$>$}}1 {<}{{$<$}}1 {\\}{{$\lambda$}}1
            {\\\\}{{\char`\\\char`\\}}1
            {->}{{$\rightarrow$}}2 {>=}{{$\geq$}}2 {<-}{{$\leftarrow$}}2
            {<=}{{$\leq$}}2 {=>}{{$\Rightarrow$}}2 
            {/=}{{$\ne$}}2
            {|}{{$\mid$}}1
  }[keywords,comments,strings]%

\lstdefinelanguage{sql}%
  {morekeywords={SELECT,SUM,IF,WHERE,FROM},%
   keepspaces,%
   sensitive,%
  }[keywords,comments,strings]%

\lstdefinelanguage{coq}%
  {morekeywords={},%
   keepspaces,%
   sensitive,%
   literate={+}{{$+$}}1 {*}{{$*$}}1 {=}{{$=$}}1
            {>}{{$>$}}1 {<}{{$<$}}1
            {\\\\}{{\char`\\\char`\\}}1
            {->}{{$\rightarrow$}}2 {>=}{{$\geq$}}2 {<-}{{$\leftarrow$}}2
            {<=}{{$\leq$}}2 {=>}{{$\Rightarrow$}}2 
            {/=}{{$\ne$}}2
            {|}{{$\mid$}}1
            {/\\}{{$\wedge$}}2
            {\\/}{{$\vee$}}2
  }[keywords,comments,strings]%

\lstdefinelanguage{process}%
  {morekeywords={process,ins,outs,heap,label,instrs,pull,push,close,case,drop,jump,exit,else,network},%
   keepspaces,%
   sensitive,%
   morecomment=[l]--,%
   literate={+}{{$+$}}1 {/}{{$/$}}1 {*}{{$*$}}1 {=}{{$=$}}1
            {>}{{$>$}}1 {<}{{$<$}}1 {\\}{{$\lambda$}}1 {/}{{$\nu$}}1
            {\\\\}{{\char`\\\char`\\}}1
            {->}{{$\rightarrow$}}2 {>=}{{$\geq$}}2 {<-}{{$\leftarrow$}}2
            {<=}{{$\leq$}}2 {=>}{{$\Rightarrow$}}2 
            {/=}{{$\ne$}}2
            {|}{{$\mid$}}1
  }[keywords,comments,strings]%



\lstnewenvironment{icicle}[1][]{\lstset{language=icicle,#1}}{}
\lstnewenvironment{icicle-core}[1][]{\lstset{language=icicle-core,#1}}{}
\lstnewenvironment{haskell}[1][]{\lstset{language=Haskell,#1}}{}
\lstnewenvironment{sql}[1][]{\lstset{language=sql,#1}}{}
\lstnewenvironment{coq}[1][]{\lstset{language=coq,#1}}{}
\lstnewenvironment{process}[1][]{\lstset{language=process,#1}}{}

% \lstnewenvironment{icicle}{\noindent\minipage{\linewidth}\lstset{language=icicle}}{\endminipage}
% \lstnewenvironment{icicle-core}{\noindent\minipage{\linewidth}\lstset{language=icicle-core}}{\endminipage}
% \lstnewenvironment{haskell}{\noindent\minipage{\linewidth}\lstset{language=Haskell}}{\endminipage}
% \lstnewenvironment{sql}{\noindent\minipage{\linewidth}\lstset{language=sql}}{\endminipage}
% \lstnewenvironment{coq}{\noindent\minipage{\linewidth}\lstset{language=coq}}{\endminipage}
% \lstnewenvironment{process}{\noindent\minipage{\linewidth}\lstset{language=process}}{\endminipage}
% 
% \BeforeBeginEnvironment{icicle}{\par}
% \BeforeBeginEnvironment{icicle-core}{\par}
% \BeforeBeginEnvironment{haskell}{\par}
% \BeforeBeginEnvironment{sql}{\par}
% \BeforeBeginEnvironment{coq}{\par}
% \BeforeBeginEnvironment{process}{\par}
% 
% \AfterEndEnvironment{icicle}{\par}
% \AfterEndEnvironment{icicle-core}{\par}
% \AfterEndEnvironment{haskell}{\par}
% \AfterEndEnvironment{sql}{\par}
% \AfterEndEnvironment{coq}{\par}
% \AfterEndEnvironment{process}{\par}

\newcommand*{\SavedLstInline}{}
\LetLtxMacro\SavedLstInline\lstinline
\DeclareRobustCommand*{\lstinline}{%
  \ifmmode
    \let\SavedBGroup\bgroup
    \def\bgroup{%
      \let\bgroup\SavedBGroup
      \hbox\bgroup
    }%
  \fi
  \SavedLstInline
}

\newcommand\Hs{\lstinline}

\def\lstiproc{\lstinline[language=process]}
\def\Ic{\lstinline[language=icicle]}
\def\IcC{\lstinline[language=icicle-core]}
